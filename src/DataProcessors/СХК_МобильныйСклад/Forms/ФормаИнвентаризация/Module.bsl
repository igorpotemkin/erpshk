
&НаКлиенте
Процедура ПриОткрытии(Отказ)
	АктивироватьСканЯчейки();
КонецПроцедуры               

&НаКлиенте
Процедура АктивироватьСканЯчейки() Экспорт 

	ЭтаФорма.Элементы.СканЯчейки.РедактированиеТекста = Истина;
	ОчиститьСканИнфо(); 
	Элементы.СканЯчейки.ОбновитьТекстРедактирования();
	Элементы.СканЯчейки.Видимость = Ложь;
	Элементы.СканЯчейки.Видимость = Истина;
	ЭтаФорма.ТекущийЭлемент = Элементы.СканЯчейки; 
	# Если МобильныйКлиент Тогда
		НачатьРедактированиеЭлемента();
	#КонецЕсли
	
КонецПроцедуры             

&НаСервере
Процедура ОчиститьСканИнфо()
	СканЯчейки = ""; 
	ЭтаФорма.Ячейка = Справочники.СХК_СкладЯчейки.ПустаяСсылка();
	ЭтаФорма.Элементы.ИнформацияЯчейка.Заголовок = "";  
КонецПроцедуры

&НаКлиенте
Процедура СканЯчейкиИзменениеТекстаРедактирования(Элемент, Текст, СтандартнаяОбработка)
	ЗаполнитьИнформациюПоШК(Текст);
КонецПроцедуры

&НаСервере
Процедура ЗаполнитьИнформациюПоШК(ШтрихКод)
	ЯчейкаПоиск = СХК_ТСДСклад.ПоискЯчейкиШК(ШтрихКод);
	ТесктИЯ = "";

	Если ЯчейкаПоиск <> Неопределено Тогда
		ЭтаФорма.Ячейка = ЯчейкаПоиск; 
		СодержаниеЯчейки = СХК_ТСДСклад.СодержимоеЯчейки(ЯчейкаПоиск);
		Если СодержаниеЯчейки.Количество()>= 1 Тогда
			Для Каждого стр из СодержаниеЯчейки Цикл
				
				ТесктИЯ = ТесктИЯ + Строка(стр.Номенклатура) + Символы.ПС + 
				Строка(стр.Серия) + Символы.ПС +
				Строка(стр.ВНаличииОстаток) + Символы.ПС + "---------------"+ Символы.ПС;
				
			КонецЦикла;                                                                    
			ЭтаФорма.Элементы.ИнформацияЯчейка.Заголовок = ТесктИЯ;
			ЭтаФорма.Элементы.ГруппаОчистить.Видимость = Истина;	
		Иначе
			ЭтаФорма.Элементы.ГруппаОчистить.Видимость = Ложь;	
		КонецЕсли;
	Иначе
		ЭтаФорма.Элементы.ИнформацияЯчейка.Заголовок = "Отсканируйте ШтрихКод ячейки";
	КонецЕсли;
		
КонецПроцедуры

&НаКлиенте
Процедура Очистить(Команда)
	//@skip-check undefined-function
	Ответ = Вопрос("Очистить ячейку ?",
	РежимДиалогаВопрос.ДаНет,
	0, // таймаут в секундах
	КодВозвратаДиалога.Да, // (необ.) кнопка по умолчанию
	"Очистить ячейку" // (необ.) заголовок
	);
	
	Если Ответ = КодВозвратаДиалога.Да Тогда
		ПеренестиТОварыВБуфер();
	КонецЕсли;
КонецПроцедуры

&НаСервере
Процедура ПеренестиТОварыВБуфер()
	
	Буфер = Справочники.СХК_СкладЯчейки.НайтиПоНаименованию("Буфер");
	
	ТоварыВЯчейке = СХК_ТСДСклад.СодержимоеЯчейки(ЭтаФорма.Ячейка);	
	
	
	Запрос = Новый Запрос;
	Запрос.Текст = "ВЫБРАТЬ ПЕРВЫЕ 1
	               |	СХК_Перемещение.Ссылка КАК Ссылка
	               |ИЗ
	               |	Документ.СХК_Перемещение КАК СХК_Перемещение
	               |ГДЕ
	               |	СХК_Перемещение.Дата МЕЖДУ &ДатаНачала И &ДатаОкончания
	               |	И СХК_Перемещение.ПометкаУдаления = &ПометкаУдаления
	               |	И СХК_Перемещение.Проведен = &Проведен"; 
	Запрос.УстановитьПараметр("ПометкаУдаления", Ложь);  
	Запрос.УстановитьПараметр("Проведен", Истина);
	Запрос.УстановитьПараметр("ДатаНачала", НачалоДня(ТекущаяДата()));
	Запрос.УстановитьПараметр("ДатаОкончания", КонецДня(ТекущаяДата())); 

	Рез = Запрос.Выполнить().Выбрать();
	
	Если Рез.Следующий() Тогда
		ТекДок = Рез.Ссылка.ПолучитьОбъект();
	Иначе
		ТекДок = Документы.СХК_Перемещение.СоздатьДокумент();
		ТекДок.Дата =ТекущаяДата();
	КонецЕсли;
	
	Для Каждого стр из ТоварыВЯчейке Цикл
		НоваяСтрока = ТекДок.ТЧТовары.Добавить();
	    НоваяСтрока.Номенклатура = стр.Номенклатура;
	    НоваяСтрока.Серия = Справочники.СерииНоменклатуры.НайтиПоНаименованию(стр.Серия);
	    НоваяСтрока.ТекЯчейка = ЭтаФорма.Ячейка; 
		НоваяСтрока.НЯчейка = Буфер; 
		НоваяСтрока.Количество = стр.ВНаличииОстаток;
		НоваяСтрока.Время = ТекущаяДата(); 
   //Справочники.СегментыНоменклатуры.НайтиПоНаименованию("Номер",стр.Серия);
		
	КонецЦикла;
 	ТекДок.Записать(РежимЗаписиДокумента.Проведение);
	ЭтаФорма.Элементы.ИнформацияЯчейка.Заголовок = "Товар перемещен в буфер";  
	
КонецПроцедуры


	
&НаКлиенте
Процедура Разместить(Команда) 
	СтруктураПараметры = Новый Структура;
	СтруктураПараметры.Вставить("Ячейка",ЯчейкаФорма());
	АдресПередаваемыхПараметров = ПоместитьВоВременноеХранилище(СтруктураПараметры,Новый УникальныйИдентификатор);
	_Параметры = новый Структура("Адрес", АдресПередаваемыхПараметров);
	ОткрытьФорму("Обработка.СХК_МобильныйСклад.Форма.ФормаРазместить", _Параметры,ЭтаФорма, , , , ,РежимОткрытияОкнаФормы.БлокироватьОкноВладельца);

КонецПроцедуры


&НаСервере
Функция ЯчейкаФорма()
	Возврат ЭтаФорма.Ячейка.Ссылка;
КонецФункции


